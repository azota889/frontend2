"use strict";(self.webpackChunkBalacoClient=self.webpackChunkBalacoClient||[]).push([[979],{44944:(P,S,d)=>{d.d(S,{Y:()=>g});var h=d(94650);let g=(()=>{class f{constructor(e){this.el=e,this.hasDecimalPoint=!1,this.hasNegativeSign=!1,this.navigationKeys=["Backspace","Delete","Tab","Escape","Enter","Home","End","ArrowLeft","ArrowRight","Clear","Copy","Paste"],this.decimal=!1,this.decimalSeparator1=".",this.decimalSeparator2=",",this.allowNegatives=!1,this.allowPaste=!0,this.negativeSign="-",this.min=-1/0,this.max=1/0,this.regex=null,this.inputElement=e.nativeElement}ngOnChanges(e){if(e.pattern&&(this.regex=this.pattern?RegExp(this.pattern):null),e.min){const i=Number(this.min);this.min=isNaN(i)?-1/0:i}if(e.max){const i=Number(this.max);this.max=isNaN(i)?1/0:i}}onBeforeInput(e){if(isNaN(Number(e.data))){if(e.data===this.decimalSeparator1||e.data===this.decimalSeparator2||e.data===this.negativeSign&&this.allowNegatives)return;e.preventDefault(),e.stopPropagation()}}onKeyDown(e){if(this.navigationKeys.indexOf(e.key)>-1||("a"===e.key||"KeyA"===e.code)&&!0===e.ctrlKey||("c"===e.key||"KeyC"===e.code)&&!0===e.ctrlKey||("v"===e.key||"KeyV"===e.code)&&!0===e.ctrlKey||("x"===e.key||"KeyX"===e.code)&&!0===e.ctrlKey||("a"===e.key||"KeyA"===e.code)&&!0===e.metaKey||("c"===e.key||"KeyC"===e.code)&&!0===e.metaKey||("v"===e.key||"KeyV"===e.code)&&!0===e.metaKey||("x"===e.key||"KeyX"===e.code)&&!0===e.metaKey)return;let i="";var o=e.key;if(e.key===this.decimalSeparator2&&(o=this.decimalSeparator1),this.decimal&&o===this.decimalSeparator1)return i=this.forecastValue(o),i.split(this.decimalSeparator1).length>2||(this.hasDecimalPoint=i.indexOf(this.decimalSeparator1)>-1,this.setNewValue(o)),void e.preventDefault();if(o===this.negativeSign&&this.allowNegatives)return i=this.forecastValue(o),i.charAt(0)!==this.negativeSign||i.split(this.negativeSign).length>2?void e.preventDefault():void(this.hasNegativeSign=i.split(this.negativeSign).length>-1);if(" "===o||isNaN(Number(o)))return void e.preventDefault();if(i=i||this.forecastValue(o),this.regex&&!this.regex.test(i))return void e.preventDefault();const r=Number(i);(r>this.max||r<this.min)&&e.preventDefault()}onPaste(e){if(!0===this.allowPaste){let i="";window.clipboardData?i=window.clipboardData.getData("text"):e.clipboardData&&e.clipboardData.getData&&(i=e.clipboardData.getData("text/plain")),this.pasteData(i),e.preventDefault()}else e.preventDefault(),e.stopPropagation()}onDrop(e){var i,o;const r=null!==(o=null===(i=e.dataTransfer)||void 0===i?void 0:i.getData("text"))&&void 0!==o?o:"";this.inputElement.focus(),this.pasteData(r),e.preventDefault()}pasteData(e){e=e.replace(",",".");const i=this.sanitizeInput(e);if(!i.includes(this.negativeSign)||!this.hasNegativeSign||this.getSelection().includes(this.negativeSign)){if(!document.execCommand("insertText",!1,i))if(this.inputElement.setRangeText){const{selectionStart:r,selectionEnd:v}=this.inputElement;this.inputElement.setRangeText(i,r??0,v??0,"end"),typeof window.InstallTrigger<"u"&&this.inputElement.dispatchEvent(new Event("input",{cancelable:!0}))}else this.insertAtCursor(this.inputElement,i);this.decimal&&(this.hasDecimalPoint=this.inputElement.value.indexOf(this.decimalSeparator1)>-1),this.hasNegativeSign=this.inputElement.value.indexOf(this.negativeSign)>-1}}setNewValue(e){e=e.replace(",","."),this.insertAtCursor(this.inputElement,e),this.decimal&&(this.hasDecimalPoint=this.inputElement.value.indexOf(this.decimalSeparator1)>-1),this.hasNegativeSign=this.inputElement.value.indexOf(this.negativeSign)>-1}insertAtCursor(e,i){var o,r;const v=null!==(o=e.selectionStart)&&void 0!==o?o:0,t=null!==(r=e.selectionEnd)&&void 0!==r?r:0;e.value=e.value.substring(0,v)+i+e.value.substring(t,e.value.length);const a=v+i.length;e.focus(),e.setSelectionRange(a,a),this.triggerEvent(e,"input")}triggerEvent(e,i){if("createEvent"in document){const o=document.createEvent("HTMLEvents");o.initEvent(i,!1,!0),e.dispatchEvent(o)}}sanitizeInput(e){let o,i="";o=this.decimal&&this.isValidDecimal(e)?new RegExp(`${this.getNegativeSignRegExp()}[^0-9${this.decimalSeparator1}]`,"g"):new RegExp(`${this.getNegativeSignRegExp()}[^0-9]`,"g"),i=e.replace(o,"");const r=this.inputElement.maxLength;if(r>0){const v=r-this.inputElement.value.length+(i.includes(`${this.negativeSign}`)?1:0);i=v>0?i.substring(0,v):""}return i}getNegativeSignRegExp(){return!this.allowNegatives||this.hasNegativeSign&&!this.getSelection().includes(this.negativeSign)?"":`(?!^${this.negativeSign})`}isValidDecimal(e){if(this.hasDecimalPoint){const i=this.getSelection();return i&&i.indexOf(this.decimalSeparator1)>-1?e.split(this.decimalSeparator1).length<=2:e.indexOf(this.decimalSeparator1)<0}return e.split(this.decimalSeparator1).length<=2}getSelection(){var e,i;return this.inputElement.value.substring(null!==(e=this.inputElement.selectionStart)&&void 0!==e?e:0,null!==(i=this.inputElement.selectionEnd)&&void 0!==i?i:0)}forecastValue(e){var i,o;const r=null!==(i=this.inputElement.selectionStart)&&void 0!==i?i:0,v=null!==(o=this.inputElement.selectionEnd)&&void 0!==o?o:0,t=this.inputElement.value;return t.substring(0,r)+e+t.substring(v)}}return f.\u0275fac=function(e){return new(e||f)(h.Y36(h.SBq))},f.\u0275dir=h.lG2({type:f,selectors:[["","appOnlyNumber",""]],hostBindings:function(e,i){1&e&&h.NdJ("beforeinput",function(r){return i.onBeforeInput(r)})("keydown",function(r){return i.onKeyDown(r)})("paste",function(r){return i.onPaste(r)})("drop",function(r){return i.onDrop(r)})},inputs:{decimal:"decimal",decimalSeparator1:"decimalSeparator1",decimalSeparator2:"decimalSeparator2",allowNegatives:"allowNegatives",allowPaste:"allowPaste",negativeSign:"negativeSign",min:"min",max:"max",pattern:"pattern"},features:[h.TTD]}),f})()},296:(P,S,d)=>{d.d(S,{S:()=>o});var h=d(70655),g=d(94650),f=d(60940),_=d(15043),e=d(90893),i=d(20814);let o=(()=>{class r{processEssayResultToBase64(t){var a;return(0,h.mG)(this,void 0,void 0,function*(){for(const n of null!==(a=t.pages)&&void 0!==a?a:[]){if(n.draw){const s=yield this.exportPdfUtilsService.convertAndRetryToBase64(n.draw);n.draw=s}if(n.backgroundImage){const s=yield this.exportPdfUtilsService.convertAndRetryToBase64(n.backgroundImage);n.backgroundImage=s}}if(t.commentEmoji&&t.commentEmoji.length){let n="https://azota889.github.io/storage_public/mnote/",s=t.commentEmoji.length;for(let l=0;l<s;l++){let c=n+t.commentEmoji[l];const u=yield this.exportPdfUtilsService.convertAndRetryToBase64(c);t.commentEmoji[l]=u}}return t})}processGroupImagesToBase64(t,a){var n,s;return(0,h.mG)(this,void 0,void 0,function*(){if(t&&null!==(n=t?.[0].name)&&void 0!==n&&n.startsWith("[PDFv2]"))for(const l of t)if(l.questionContentParse&&l.questionContentParse[0].groupUrl&&a.includes(null!==(s=l.indexLabel)&&void 0!==s?s:-1)){const c=yield this.exportPdfUtilsService.convertAndRetryToBase64(l.questionContentParse[0].groupUrl);l.questionContentParse[0].groupUrl=c}})}processQuestionImagesToBase64(t){var a,n;return(0,h.mG)(this,void 0,void 0,function*(){if(1==t[0].isImage)for(const s of t){const l=yield this.exportPdfUtilsService.convertAndRetryToBase64(null!==(n=null===(a=s.questionContentParse)||void 0===a?void 0:a[0].url)&&void 0!==n?n:"");s.questionContentParse&&(s.questionContentParse[0].url=l)}})}processQuestionDocxContentToBase64(t){var a,n,s,l;return(0,h.mG)(this,void 0,void 0,function*(){if(0==t[0].isImage)for(const u of t){var c=this.exportPdfUtilsService.findImageSrcInContent(null!==(n=null===(a=u.questionContentParse)||void 0===a?void 0:a[0].content)&&void 0!==n?n:"");if(c&&!c.includes(";base64")){const p=yield this.exportPdfUtilsService.convertAndRetryToBase64(c);null!==(l=null===(s=u.questionContentParse)||void 0===s?void 0:s[0].content)&&void 0!==l&&l.includes("img")&&p&&(u.questionContentParse[0].content=u.questionContentParse[0].content.replace(c,p))}}})}convertAnswersArr(t,a){0!=t.length&&t.forEach(n=>{n.QuestionId&&n.AnswerContent&&n.AnswerContent[0]&&n.AnswerContent[0].Content&&(a[`id_${n.QuestionId}`]=n.AnswerContent[0].Content)})}findScaleDirection(t,a){return t/a>=.7070707070707071?"w":"h"}constructor(t,a,n,s){this.commonService=t,this.cdnService=a,this.customQuestionAnswerConfig=n,this.exportPdfUtilsService=s}}return r.\u0275fac=function(t){return new(t||r)(g.LFG(f.v),g.LFG(_.U),g.LFG(e.U),g.LFG(i.V))},r.\u0275prov=g.Yz7({token:r,factory:r.\u0275fac,providedIn:"root"}),r})()},20814:(P,S,d)=>{d.d(S,{V:()=>o});var h=d(70655),g=d(94650),f=d(60940),_=d(15043),e=d(24029),i=(()=>{return(r=i||(i={}))[r.Cdn=0]="Cdn",r[r.CdnTimestamp=1]="CdnTimestamp",r[r.Rawlink=2]="Rawlink",r[r.RawlinkTimestamp=3]="RawlinkTimestamp",i;var r})();let o=(()=>{class r{get blockCropItemClass(){return"__CANVAS_CROP_ITEM"}get blockEssayCropItemClass(){return"_ESSAY"}isSupportedBrowser(){let t=this.commonService.getBrowserType().toString();return!(!["chrome"].includes(t.split(" ")[0].toLowerCase())||parseInt(t.split(" ")[1],10)<80)}getExtensionFile(t){if(!t)return"";var a=t.split(".");return a.length<=1?"":a[a.length-1].toLocaleLowerCase().split("_")[0]}translateMetaTitle(t){var a,n,s,l;let c="Export PDF: ";this.commonService.translateMetaData({title:c+(null===(n=null===(a=t.data)||void 0===a?void 0:a.examObj)||void 0===n?void 0:n.name),description:c+(null===(l=null===(s=t.data)||void 0===s?void 0:s.examObj)||void 0===l?void 0:l.name),image:"lang_cms_test_image"})}findImageSrcInContent(t){var a="";if(t.includes("img")){var n=t.indexOf("img"),s=t.indexOf("src=",n),l=t.indexOf('"',Number(s)+5);a=t.substring(Number(s)+5,Number(l))}return a}asyncTimeout(t){return(0,h.mG)(this,void 0,void 0,function*(){return`Waited ${yield new Promise(n=>{setTimeout(()=>n(t),t)})} miliseconds`})}parseEssayMarkResult(t,a){let n=t.filter(c=>this.answerTypeService.isEssayAnswer(c.answerType));if(0!=n.length&&a&&a.essayResult){var s=this.commonService.willDeleteParseJson(a.essayResult);if(s){var l=Object.entries(s);for(let c=0;c<n.length;c++)n[c].essayMarkParsed=l[c][1]}}}convertToBase64(t,a){return(0,h.mG)(this,void 0,void 0,function*(){let n=t;switch(a){case i.Cdn:n=this.cdnService.getMyCdn(t);break;case i.CdnTimestamp:n=this.cdnService.getMyCdn(t)+"?t="+Date.now();break;case i.RawlinkTimestamp:n=t+"?t="+Date.now()}const l=yield(yield fetch(n)).blob(),c=yield new Promise(u=>{const p=new FileReader;p.readAsDataURL(l),p.onloadend=()=>{u(p.result)}});return c&&"string"==typeof c?c:t})}convertAndRetryToBase64(t){return(0,h.mG)(this,void 0,void 0,function*(){let a=this.getExtensionFile(t);if(["pdf","jpg","jpeg","png","gif"].includes(a)){let n;const s=[i.Cdn,i.CdnTimestamp,i.Rawlink,i.RawlinkTimestamp];try{n=yield this.convertToBase64(t,s[0])}catch{try{n=yield this.convertToBase64(t,s[1])}catch{try{n=yield this.convertToBase64(t,s[2])}catch{try{n=yield this.convertToBase64(t,s[3])}catch{console.log("Kh\xf4ng th\u1ec3 convert url n\xe0y th\xe0nh base64 sau v\xe0i l\u1ea7n retry: "+t),n=t}}}}return n}return t})}eraseCanvas(t){t&&(t.beginPath(),t.rect(0,0,t.canvas.width,t.canvas.height),t.fillStyle="white",t.fill())}addContentToPdf(t,a){t.addImage(a,"JPEG",0,0,t.internal.pageSize.getWidth(),t.internal.pageSize.getHeight())}drawTextWrap(t,a,n,s,l){let c=t.split(" "),u=[],p=c[0];if(a){a.font=l||`${s}px Arial`;for(let m=1;m<c.length;m++){let E=c[m];a.measureText(p+" "+E).width<n?p+=" "+E:(u.push(p),p=E)}u.push(p)}return u}essayText2LinesArr(t,a,n,s,l){var c;let u=new RegExp("(<br>|<br/>)+","igm"),m=(null!==(c=this.commonService.replaceAllByRegExp(t,u,"<br>"))&&void 0!==c?c:"").split("<br>"),E=[];for(let y=0;y<m.length;y++)E.push(this.drawTextWrap(m[y],a,n,s,l));return E}constructor(t,a,n){this.commonService=t,this.cdnService=a,this.answerTypeService=n}}return r.\u0275fac=function(t){return new(t||r)(g.LFG(f.v),g.LFG(_.U),g.LFG(e.T))},r.\u0275prov=g.Yz7({token:r,factory:r.\u0275fac,providedIn:"root"}),r})()}}]);